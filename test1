getgenv().gg = false
if getgenv().gg then
    print("already")
    return
end
getgenv().gg = true

--// –°–µ—Ä–≤–∏—Å—ã
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local Players = game:GetService("Players")
local virtualUser = game:GetService("VirtualUser")

--// –ö–æ–Ω—Ñ–∏–≥
local apiKey = "S3mWs7P1fzVUPTmcjjpvekjKO7N72sI0tZFgVx5N2FS92yCP6XkxniDX4mND"
local codeUrl = "https://raw.githubusercontent.com/Roma77799/testik/refs/heads/main/test2"

--// –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
local lastDeletedId = "" -- –ß—Ç–æ–±—ã –Ω–µ –ø—ã—Ç–∞—Ç—å—Å—è –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —É–∂–µ —É–¥–∞–ª–µ–Ω–Ω—É—é –ø–∞—Å—Ç—É
local teleportFailedHandled = false
local isProcessing = false -- –§–ª–∞–≥, —á—Ç–æ–±—ã —Ü–∏–∫–ª –Ω–µ –º–µ—à–∞–ª —Ç–µ–ª–µ–ø–æ—Ä—Ç—É

--// –ó–∞–≥–æ–ª–æ–≤–∫–∏
local headers = {
    ["Accept"] = "application/json",
    ["Content-Type"] = "application/json",
    ["Authorization"] = "Bearer " .. apiKey,
}

--// –ê–Ω—Ç–∏-–ê–§–ö
Players.LocalPlayer.Idled:Connect(function()
    virtualUser:CaptureController()
    virtualUser:ClickButton2(Vector2.new())
end)

--// –£—Ç–∏–ª–∏—Ç—ã
function missing(t, f, fallback)
    if type(f) == t then return f end
    return fallback
end

local queueteleport = missing("function", queue_on_teleport or (syn and syn.queue_on_teleport) or (fluxus and fluxus.queue_on_teleport))

local function parseDateTime(dateStr)
    local year, month, day, hour, min, sec = dateStr:match("(%d+)%-(%d+)%-(%d+) (%d+):(%d+):(%d+)")
    if year then
        return os.time({
            year = tonumber(year), month = tonumber(month), day = tonumber(day),
            hour = tonumber(hour), min = tonumber(min), sec = tonumber(sec)
        })
    end
    return 0
end

--// –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø–∞—Å—Ç—ã
local function deletePaste(pasteId)
    if not pasteId or pasteId == "" or pasteId == lastDeletedId then return false end

    local deleteUrl = "https://pastefy.app/api/v2/paste/" .. pasteId
    local req = { Url = deleteUrl, Method = "DELETE", Headers = headers }
    local response = request(req)

    lastDeletedId = pasteId -- –°—Ä–∞–∑—É –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ —É–¥–∞–ª–µ–Ω–Ω—É—é –≤ –ø–∞–º—è—Ç–∏
    
    if not response then return false, "No response" end

    if response.StatusCode == 404 then
        warn("‚ùå –ü–∞—Å—Ç–∞ —É–∂–µ —É–¥–∞–ª–µ–Ω–∞ (404):", pasteId)
        return true -- –°—á–∏—Ç–∞–µ–º —É—Å–ø–µ—Ö–æ–º, —Ä–∞–∑ –µ—ë –∏ —Ç–∞–∫ –Ω–µ—Ç
    end

    if response.StatusCode == 200 or response.StatusCode == 204 then
        print("‚úÖ –ü–∞—Å—Ç–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞ —Å Pastefy")
        return true
    end

    return false, "Status: " .. tostring(response.StatusCode)
end

--// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞
local deleteOnError = {
    [Enum.TeleportResult.GameNotFound] = true,
    [Enum.TeleportResult.GameEnded] = true,
    [Enum.TeleportResult.Unauthorized] = true,
    [Enum.TeleportResult.Failure] = true,
}

TeleportService.TeleportInitFailed:Connect(function(player, result)
    if teleportFailedHandled then return end
    
    if deleteOnError[result] then
        teleportFailedHandled = true
        warn("üßπ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞ ("..tostring(result).."). –ß–∏—Å—Ç–∏–º —Ö–≤–æ—Å—Ç—ã...")
        
        if getgenv().paste then
            deletePaste(getgenv().paste)
            getgenv().paste = nil
            getgenv().name = nil
        end
        
        task.wait(5) -- –ü–∞—É–∑–∞, —á—Ç–æ–±—ã API Pastefy —É—Å–ø–µ–ª–æ –æ–±–Ω–æ–≤–∏—Ç—å—Å—è
        teleportFailedHandled = false
        isProcessing = false -- –†–∞–∑—Ä–µ—à–∞–µ–º —Ü–∏–∫–ª—É –∏—Å–∫–∞—Ç—å –Ω–æ–≤—É—é –ø–∞—Å—Ç—É
    end
end)

--// –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
local function getOldestPaste()
    if isProcessing then return true end -- –ï—Å–ª–∏ —É–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º

    local success, response = pcall(function()
        return request({
            Url = "https://pastefy.app/api/v2/user/pastes",
            Method = "GET",
            Headers = headers
        })
    end)

    if not success or not response or response.StatusCode ~= 200 then
        return false, "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ API (Status: "..(response and response.StatusCode or "nil")..")"
    end

    local ok, data = pcall(function() return HttpService:JSONDecode(response.Body) end)
    if not ok or type(data) ~= "table" or #data == 0 then
        return false, "–ü–∞—Å—Ç –Ω–µ—Ç"
    end

    -- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ
    table.sort(data, function(a, b)
        return parseDateTime(a.created_at) < parseDateTime(b.created_at)
    end)

    -- –ë–µ—Ä–µ–º —Å–∞–º—É—é —Å—Ç–∞—Ä—É—é, –∫–æ—Ç–æ—Ä–∞—è –µ—â–µ –Ω–µ –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞ –Ω–∞–º–∏
    local oldest = nil
    for _, p in ipairs(data) do
        if p.id ~= lastDeletedId then
            oldest = p
            break
        end
    end

    if not oldest then return false, "–í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–∞—Å—Ç—ã —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã" end

    local content = oldest.content or ""
    local lines = {}
    for line in content:gmatch("[^\r\n]+") do table.insert(lines, line) end

    local jobId = lines[1]
    local gameid = lines[2]
    local playerName = lines[3]

    if not jobId or not gameid then
        deletePaste(oldest.id) -- –£–¥–∞–ª—è–µ–º –±–∏—Ç—É—é –ø–∞—Å—Ç—É
        return false, "–ë–∏—Ç–∞—è –ø–∞—Å—Ç–∞ (–Ω–µ—Ç ID), —É–¥–∞–ª–µ–Ω–∞"
    end

    -- –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Ç–µ–ª–µ–ø–æ—Ä—Ç—É
    getgenv().name = playerName or ""
    getgenv().paste = oldest.id
    isProcessing = true -- –ë–ª–æ–∫–∏—Ä—É–µ–º —Ü–∏–∫–ª

    local queueCode = string.format([[ 
        getgenv().name = "%s"
        getgenv().paste = "%s"
        spawn(function()
            repeat task.wait() until game:IsLoaded()
            local success, err = pcall(function()
                local code = game:HttpGet("%s")
                if not code or code == "" then error("Failed to fetch script") end
                local func, compileErr = loadstring(code)
                if not func then error("–û—à–∏–±–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏: "..tostring(compileErr)) end
                func()
            end)
            if not success then warn("–û—à–∏–±–∫–∞ –ø–æ—Å–ª–µ —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞:", err) end
        end)
    ]], getgenv().name, getgenv().paste, codeUrl)

    if queueteleport then queueteleport(queueCode) end

    print("üöÄ –ü–æ–ø—ã—Ç–∫–∞ —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä: " .. jobId)
    TeleportService:TeleportToPlaceInstance(gameid, jobId)
    
    return true -- –£—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–æ
end

print("–°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω, –Ω–∞—á–∏–Ω–∞—é –ø–æ–∏—Å–∫ –ø–∞—Å—Ç...")

while true do
    -- ok - —É—Å–ø–µ—à–Ω–æ –ª–∏ –≤—ã–ø–æ–ª–Ω–∏–ª—Å—è pcall
    -- result - —á—Ç–æ –≤–µ—Ä–Ω—É–ª–∞ —Ñ—É–Ω–∫—Ü–∏—è (true/false) –∏–ª–∏ —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ Lua
    -- msg - —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ, –µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –≤–µ—Ä–Ω—É–ª–∞ false
    local ok, result, msg = pcall(getOldestPaste)
    
    if not ok then
        -- –°—é–¥–∞ –ø–æ–ø–∞–¥–∞—é—Ç —Å–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏ Xeno (Timedout) –∏ –æ—à–∏–±–∫–∏ —Å–∞–º–æ–≥–æ –∫–æ–¥–∞
        local errorText = tostring(result)
        warn("‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:", errorText)
        
        if errorText:find("Timedout") or errorText:find("403") then
            print("‚è≥ –°–µ—Ç—å –ª–∞–≥–∞–µ—Ç, –∂–¥—É 15 —Å–µ–∫—É–Ω–¥...")
            task.wait(15)
        else
            task.wait(6)
        end

    elseif result == false then
        -- –°—é–¥–∞ –ø–æ–ø–∞–¥–∞–µ–º, –µ—Å–ª–∏ –ø–∞—Å—Ç –ø—Ä–æ—Å—Ç–æ –Ω–µ—Ç –∏–ª–∏ API Pastefy –≤–µ—Ä–Ω—É–ª–æ –æ—à–∏–±–∫—É
        if msg ~= "–ü–∞—Å—Ç –Ω–µ—Ç" then 
            warn("–°—Ç–∞—Ç—É—Å:", msg) 
        end
        
        -- –ï—Å–ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–∞ 503 –∏–ª–∏ 504 (Pastefy —É—Å—Ç–∞–ª), –∂–¥–µ–º –¥–æ–ª—å—à–µ
        if tostring(msg):find("503") or tostring(msg):find("504") then
            task.wait(15)
        else
            task.wait(6)
        end

    else
        task.wait(6)
    end
end
